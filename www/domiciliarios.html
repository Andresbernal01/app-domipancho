<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DomiPancho | Pedidos Domiciliario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="img/logo.png">
  <link rel="stylesheet" href="css/domiciliarios.css" />
  <script src="js/config.js"></script>
</head>
<body>

  <header class="header">
    <div class="header-container">
      <button class="btn-volver" onclick="window.location.href='inicio_domi.html'">
        ⬅ <span>Volver</span>
      </button>
  
      <div class="header-center">
        <h1>📦 Pedidos Activos</h1>
      </div>
  
      <div id="contadorPedidos" class="pedidos-activos-contador">
        <span id="numPedidosActivos">0</span>/2
      </div>
    </div>
  </header>

  <div class="main-container">
    <main>
      <div id="listaPedidos" class="loading">
        <p>Cargando pedidos...</p>
      </div>
    </main>
  </div>

  <div id="mensajeSistema" class="mensaje-sistema" style="display:none;"></div>

  <!-- MODAL PROBLEMA -->
  <div id="modalProblema" class="modal-problema" style="display: none;">
    <div class="modal-contenido">
      <h2>❌ Reportar Problema con el Pedido</h2>
  
      <label for="motivo">Motivo:</label>
      <select id="motivo" onchange="mostrarOtroCampo(this.value)">
        <option value="">Seleccione una opción</option>
        <option value="cliente no respondió">Cliente no respondió</option>
        <option value="dirección incorrecta">Dirección incorrecta</option>
        <option value="cliente canceló al llegar">Cliente canceló al llegar</option>
        <option value="pedido rechazado">Pedido rechazado</option>
        <option value="otro">Otro</option>
      </select>
  
      <div id="campoOtro" style="display:none;">
        <label for="detalle_motivo">Explique el motivo:</label>
        <input type="text" id="detalle_motivo" placeholder="Describa el motivo" />
      </div>
  
      <label>¿Llamaste al restaurante?</label>
      <div>
        <label><input type="radio" name="llamo_restaurante" value="sí"> Sí</label>
        <label><input type="radio" name="llamo_restaurante" value="no"> No</label>
      </div>
  
      <label>¿Qué hiciste con el pedido?</label>
      <select id="accion_pedido">
        <option value="">Seleccione una opción</option>
        <option value="lo devolví al restaurante">Lo devolví al restaurante</option>
        <option value="el restaurante dijo que lo dejara/botara">El restaurante dijo que lo dejara/botara</option>
        <option value="no lo devolví">No lo devolví (explicar)</option>
      </select>
      <div id="campoExplicacionNoDevolvi" style="display: none;">
        <label for="explicacion_no_devolvi">¿Por qué no lo devolviste?</label>
        <input type="text" id="explicacion_no_devolvi" placeholder="Escribe tu explicación aquí" />
      </div>
      
      <div class="modal-acciones">
        <button onclick="confirmarNoEntregado()">🔴 Confirmar como No Entregado</button>
        <button onclick="cerrarModalProblema()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL MÉTODO DE PAGO -->
  <div id="modalMetodoPago" class="modal-problema" style="display: none;">
    <div class="modal-contenido">
      <h2>💳 Selecciona el Método de Pago</h2>
      
      <div class="metodos-pago">
        <label>
          <input type="radio" name="metodo_pago" value="efectivo">
          <span>💵 Efectivo</span>
        </label>
        
        <label>
          <input type="radio" name="metodo_pago" value="app">
          <span>📱 Pago por App (QR Universal)</span>
        </label>
      </div>
      
      <p>
        💡 <strong>Importante:</strong> Si es pago por App, muéstrale el QR físico al cliente para que pueda escanearlo.
      </p>
      
      <div class="modal-acciones">
        <button onclick="confirmarEntrega()" id="btnConfirmarEntrega" disabled>
          ✅ Confirmar Entrega
        </button>
        <button onclick="cerrarModalPago()">
          ❌ Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL LIBERAR PEDIDO -->
  <div id="modalLiberarPedido" class="modal-problema" style="display: none;">
    <div class="modal-contenido">
      <h2>🔄 Liberar Pedido</h2>
      
      <p>¿Estás seguro de que quieres liberar este pedido? Estará disponible para otros domiciliarios.</p>
      
      <label for="motivo_liberacion">Motivo de liberación:</label>
      <select id="motivo_liberacion" onchange="mostrarDetalleMotivo(this.value)">
        <option value="">Seleccionar motivo</option>
        <option value="emergencia personal">Emergencia personal</option>
        <option value="problema vehiculo">Problema con vehículo</option>
        <option value="demora imprevista">Demora imprevista</option>
        <option value="sobrecarga trabajo">Sobrecarga de trabajo</option>
        <option value="otro">Otro motivo</option>
      </select>
      
      <div id="campoDetalleMotivo" style="display:none; margin-top: 10px;">
        <label for="detalle_motivo_liberacion">Detalle del motivo:</label>
        <textarea id="detalle_motivo_liberacion" placeholder="Explica brevemente el motivo..." rows="3"></textarea>
      </div>
      
      <div class="modal-acciones">
        <button onclick="confirmarLiberarPedido()" style="background-color: #f59e0b;">✅ Liberar Pedido</button>
        <button onclick="cerrarModalLiberar()">❌ Cancelar</button>
      </div>
    </div>
  </div>

  <!-- ✅ SCRIPTS OPTIMIZADOS - SOLO FCM -->
  <script src="js/socket-mock.js"></script>
  <script src="js/unified-geolocation.js"></script>
  <script src="js/inactividad.js"></script>
  <script src="js/domiciliario.js"></script>
  <script src="js/fcm-notifications.js"></script>

  <script>

async function validarAntesDeSalir() {
  try {
    const response = await window.apiRequest('/api/pedidos-domiciliario-con-distancias');
    if (response.ok) {
      const pedidos = await response.json();
      const pedidosActivos = pedidos.filter(p => p.estado?.toLowerCase() === 'camino a tu casa');
      
      if (pedidosActivos.length > 0) {
        alert(`⚠️ Tienes ${pedidosActivos.length} pedido(s) activo(s).\n\nRecuerda que mientras tengas pedidos activos, debes mantener la app abierta para que se rastree tu ubicación.`);
      }
    }
  } catch (error) {
    console.error('Error:', error);
  }
}

// Al cargar la página
document.addEventListener('DOMContentLoaded', async () => {
  console.log('🎯 Inicializando domiciliarios.html...');
  
  // ... código existente ...
});

// ✅ VALIDAR AL HACER CLIC EN VOLVER
document.querySelector('.btn-volver')?.addEventListener('click', async (e) => {
  e.preventDefault();
  await validarAntesDeSalir();
  window.location.href = 'inicio_domi.html';
});

document.addEventListener('DOMContentLoaded', async () => {
  console.log('🎯 Inicializando domiciliarios.html...');
  
  // ✅ 1. VERIFICAR DISPONIBILIDAD ANTES DE TRACKING
  let disponible = true;
  try {
    const dispResponse = await window.apiRequest('/api/domiciliario/estado-disponibilidad');
    if (dispResponse.ok) {
      const dispData = await dispResponse.json();
      disponible = dispData.disponible !== false;
    }
  } catch (error) {
    console.warn('Error verificando disponibilidad:', error);
  }

  // ✅ 2. SOLO INICIAR TRACKING SI ESTÁ DISPONIBLE
  if (disponible) {
    if (window.unifiedGeoService) {
      try {
        await window.unifiedGeoService.initialize();
        await window.unifiedGeoService.startTracking();
        console.log('✅ Tracking activo (disponible)');
      } catch (error) {
        console.error('❌ Error tracking:', error);
      }
    }
  } else {
    console.log('🔴 No disponible - NO se inicia tracking');
  }
  
  // ✅ 3. INICIALIZAR FCM
  if (window.fcmNotificationService) {
    try {
      await window.fcmNotificationService.inicializar();
      console.log('✅ FCM inicializado');
    } catch (error) {
      console.error('❌ Error FCM:', error);
    }
  }
  
  console.log('✅ Sistema completamente inicializado');
});

// ✅ 3. MANTENER TRACKING AL VOLVER A LA APP
document.addEventListener('visibilitychange', async () => {
  if (!document.hidden && window.unifiedGeoService) {
    console.log('📱 Aplicación restaurada del background');
    
    // Verificar si hay pedidos activos
    const tienePedidoActivo = localStorage.getItem('domiciliario_pedido_activo');
    
    if (tienePedidoActivo === 'true') {
      console.log('🔄 Pedido activo detectado - asegurando tracking');
      
      // Reiniciar tracking si se detuvo
      if (!window.unifiedGeoService.isTracking && 
          window.unifiedGeoService.permissionStatus === 'granted') {
        console.log('🔄 Reiniciando tracking...');
        
        try {
          await window.unifiedGeoService.startTracking();
          console.log('✅ Tracking reiniciado correctamente');
        } catch (error) {
          console.error('❌ Error reiniciando tracking:', error);
        }
      } else {
        console.log('✅ Tracking ya está activo');
      }
    }
  }
});
  </script>
</body>
</html>