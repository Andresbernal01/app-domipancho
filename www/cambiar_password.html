<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cambiar Contrase√±a | DomiPancho</title>
  <link rel="icon" href="img/logo.png" />
  <link rel="stylesheet" href="css/cambiar_password.css" />
  <link rel="stylesheet" href="css/header.css">
  <script src="js/config.js"></script>

  <style>
    /* Estilos para los botones de mostrar/ocultar contrase√±a */
    .password-field {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-field input {
      padding-right: 40px;
      flex: 1;
    }

    .toggle-password {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      padding: 5px;
      color: #666;
      transition: color 0.3s ease;
    }

    .toggle-password:hover {
      color: #333;
    }

    /* Modal para mensaje de √©xito */
    .success-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .success-modal.show {
      display: flex;
    }

    .success-modal-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      margin: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.4s ease;
    }

    .success-icon {
      font-size: 60px;
      margin-bottom: 20px;
      animation: bounce 0.6s ease;
    }

    .success-title {
      font-size: 24px;
      font-weight: bold;
      color: #2d5a27;
      margin-bottom: 10px;
    }

    .success-message {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .success-button {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: transform 0.3s ease;
    }

    .success-button:hover {
      transform: translateY(-2px);
    }

    /* üö´ Estilos para el bloqueo de tiempo */
    .blocked-container {
      background: linear-gradient(135deg, #ffebee, #f8bbd9);
      border: 2px solid #e91e63;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(233, 30, 99, 0.2);
    }

    .blocked-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }

    .blocked-title {
      font-size: 28px;
      font-weight: bold;
      color: #c2185b;
      margin-bottom: 15px;
    }

    .blocked-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 25px;
      line-height: 1.6;
    }

    .countdown-container {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #e91e63;
    }

    .countdown-title {
      font-size: 18px;
      font-weight: bold;
      color: #c2185b;
      margin-bottom: 15px;
    }

    .countdown-display {
      font-family: 'Courier New', monospace;
      font-size: 24px;
      font-weight: bold;
      color: #d32f2f;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e91e63;
      margin-bottom: 10px;
    }

    .countdown-labels {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      font-weight: bold;
    }

    .form-container.blocked {
      opacity: 0.5;
      pointer-events: none;
      filter: grayscale(100%);
    }

    .blocked-info {
      background: #4a4846;
      border: 1px solid #ff9800;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .blocked-info strong {
      color: #e65100;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-container">
      <!-- Bot√≥n Volver -->
      <div id="boton-volver-container"></div>


      <!-- Centro: Logo + Nombre -->
      <div class="header-center">
        <img src="img/logo.png" alt="Logo DomiPancho" class="logo" />
        <div class="restaurant-info">
          <h1 id="restaurantName">Cargando...</h1>
        </div>
      </div>



      <!-- Usuario -->
      <div class="header-right" >
        <div class="user-info">
          <div class="user-icon">üë§</div>
          <span class="user-label">Usuario:</span>
          <span id="userName">-</span>
        </div>
      </div>
    </div>
  </header>

  <div class="main-container">
    <!-- üö´ Contenedor de bloqueo -->
    <div id="blockedContainer" class="blocked-container" style="display: none;">
      <div class="blocked-icon">üîí</div>
      <div class="blocked-title">Cambio de Contrase√±a Bloqueado</div>
      <div class="blocked-message">
        Por seguridad, solo puedes cambiar tu contrase√±a una vez cada <strong>48 horas</strong>.<br>
        Debes esperar el tiempo restante antes de realizar otro cambio.
      </div>
      
      <div class="countdown-container">
        <div class="countdown-title">‚è±Ô∏è Tiempo restante:</div>
        <div class="countdown-display" id="countdownDisplay">00:00:00</div>
        <div class="countdown-labels">
          <span>Horas</span>
          <span>Minutos</span>
          <span>Segundos</span>
        </div>
      </div>

      <div class="blocked-info">
        <strong>üìÖ √öltimo cambio:</strong> <span id="ultimoCambio">-</span><br>
        <strong>üïê Pr√≥ximo cambio disponible:</strong> <span id="proximoCambio">-</span>
      </div>
    </div>

    <!-- üìù Formulario normal -->
    <div id="formContainer" class="form-container">
      <div class="form-title">
        üîë Actualizar Contrase√±a
      </div>
      
      <form id="formCambio">
        <div class="form-group">
          <label for="actual">üîí Contrase√±a Actual:</label>
          <div class="password-field">
            <input type="password" name="actual" id="actual" required>
            <button type="button" class="toggle-password" onclick="togglePassword('actual')">üëÅÔ∏è</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="nueva">üÜï Nueva Contrase√±a:</label>
          <div class="password-field">
            <input type="password" name="nueva" id="nueva" required>
            <button type="button" class="toggle-password" onclick="togglePassword('nueva')">üëÅÔ∏è</button>
          </div>
          
          <div id="passwordRequirements" class="password-requirements">
            <h4>üìã Requisitos de la contrase√±a:</h4>
            <div class="requirement" id="req-length">
              <span class="icon">‚ùå</span>
              <span>M√≠nimo 8 caracteres</span>
            </div>
            <div class="requirement" id="req-uppercase">
              <span class="icon">‚ùå</span>
              <span>Al menos una letra may√∫scula</span>
            </div>
            <div class="requirement" id="req-lowercase">
              <span class="icon">‚ùå</span>
              <span>Al menos una letra min√∫scula</span>
            </div>
            <div class="requirement" id="req-number">
              <span class="icon">‚ùå</span>
              <span>Al menos un n√∫mero</span>
            </div>
            <div id="passwordStrength" class="password-strength"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="confirmar">‚úÖ Confirmar Nueva Contrase√±a:</label>
          <div class="password-field">
            <input type="password" name="confirmar" id="confirmar" required>
            <button type="button" class="toggle-password" onclick="togglePassword('confirmar')">üëÅÔ∏è</button>
          </div>
        </div>
        
        <button type="submit" class="submit-btn" id="submitBtn" disabled>
          üîÑ Cambiar Contrase√±a
        </button>

        <p style="margin-top: 10px; text-align: center; color:#facc15"> Recuerda que solo puedes cambiar la contrase√±a una vez cada 48 horas.</p>
        
        <div id="mensaje" class="mensaje"></div>
      </form>
    </div>
  </div>

  <!-- Modal de √©xito -->
  <div id="successModal" class="success-modal">
    <div class="success-modal-content">
      <div class="success-icon">üéâ</div>
      <div class="success-title">¬°Contrase√±a Actualizada!</div>
      <div class="success-message">
        Tu contrase√±a ha sido cambiada exitosamente.<br>
        Tu cuenta ahora est√° m√°s segura.<br><br>
        <strong>‚ö†Ô∏è Nota:</strong> No podr√°s cambiarla nuevamente durante las pr√≥ximas <strong>48 horas</strong>.
      </div>
      <button class="success-button" onclick="closeSuccessModal()">
        ¬°Perfecto! üëç
      </button>
    </div>
  </div>

  <script>
    let countdownInterval = null;
    
    const inputs = {
      actual: document.getElementById('actual'),
      nueva: document.getElementById('nueva'),
      confirmar: document.getElementById('confirmar')
    };
    
    const requirements = document.getElementById('passwordRequirements');
    const submitBtn = document.getElementById('submitBtn');
    const mensaje = document.getElementById('mensaje');

    // üîê Verificar si puede cambiar contrase√±a al cargar la p√°gina
    async function verificarPermisosCambio() {
      try {
        const response = await window.apiRequest('/api/puede-cambiar-password');
        const data = await response.json();

        if (!data.puede_cambiar) {
          mostrarBloqueoPorTiempo(data);
        } else {
          mostrarFormularioNormal();
        }
      } catch (error) {
        console.error('Error al verificar permisos:', error);
        mostrarFormularioNormal(); // Mostrar formulario por defecto si hay error
      }
    }

    function mostrarBloqueoPorTiempo(data) {
  document.getElementById('blockedContainer').style.display = 'block';
  document.getElementById('formContainer').style.display = 'none'; // üîí Oculta el formulario completamente


      // Mostrar informaci√≥n de fechas
      if (data.ultimo_cambio) {
        document.getElementById('ultimoCambio').textContent = formatearFecha(data.ultimo_cambio);
      }
      if (data.siguiente_cambio) {
        document.getElementById('proximoCambio').textContent = formatearFecha(data.siguiente_cambio);
      }

      // Iniciar countdown
      iniciarCountdown(data.tiempo_restante_ms);
    }

    function mostrarFormularioNormal() {
      document.getElementById('blockedContainer').style.display = 'none';
      document.getElementById('formContainer').classList.remove('blocked');
    }

    function iniciarCountdown(tiempoRestanteMs) {
      let tiempoRestante = tiempoRestanteMs;
      
      const actualizarCountdown = () => {
        if (tiempoRestante <= 0) {
          clearInterval(countdownInterval);
          document.getElementById('countdownDisplay').textContent = '¬°Disponible ahora!';
          
          // Recargar la p√°gina para mostrar el formulario
          setTimeout(() => {
            window.location.reload();
          }, 2000);
          return;
        }

        const horas = Math.floor(tiempoRestante / (1000 * 60 * 60));
        const minutos = Math.floor((tiempoRestante % (1000 * 60 * 60)) / (1000 * 60));
        const segundos = Math.floor((tiempoRestante % (1000 * 60)) / 1000);

        const display = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        document.getElementById('countdownDisplay').textContent = display;

        tiempoRestante -= 1000;
      };

      actualizarCountdown();
      countdownInterval = setInterval(actualizarCountdown, 1000);
    }

    function formatearFecha(fechaISO) {
      const fecha = new Date(fechaISO);
      return fecha.toLocaleString('es-CO', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // Funci√≥n para mostrar/ocultar contrase√±a
    function togglePassword(fieldId) {
      const field = document.getElementById(fieldId);
      const button = field.nextElementSibling;
      
      if (field.type === 'password') {
        field.type = 'text';
        button.textContent = 'üôà';
      } else {
        field.type = 'password';
        button.textContent = 'üëÅÔ∏è';
      }
    }

    // Mostrar modal de √©xito
    function showSuccessModal() {
      document.getElementById('successModal').classList.add('show');
    }

    // Cerrar modal de √©xito y recargar para mostrar bloqueo
    function closeSuccessModal() {
      document.getElementById('successModal').classList.remove('show');
      
      // Recargar la p√°gina para mostrar el bloqueo
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }

    // Mostrar requisitos cuando se enfoque en nueva contrase√±a
    inputs.nueva.addEventListener('focus', () => {
      requirements.classList.add('show');
    });

    // Validaci√≥n en tiempo real de la nueva contrase√±a
    inputs.nueva.addEventListener('input', validatePassword);
    inputs.confirmar.addEventListener('input', validateForm);
    inputs.actual.addEventListener('input', validateForm);

    function validatePassword() {
      const password = inputs.nueva.value;
      const reqs = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password)
      };

      // Actualizar indicadores visuales
      updateRequirement('req-length', reqs.length);
      updateRequirement('req-uppercase', reqs.uppercase);
      updateRequirement('req-lowercase', reqs.lowercase);
      updateRequirement('req-number', reqs.number);

      // Calcular fortaleza
      const validReqs = Object.values(reqs).filter(Boolean).length;
      updatePasswordStrength(validReqs);

      // Validar input
      const isValid = Object.values(reqs).every(Boolean);
      inputs.nueva.className = password ? (isValid ? 'valid' : 'invalid') : '';

      validateForm();
    }

    function updateRequirement(id, isValid) {
      const element = document.getElementById(id);
      const icon = element.querySelector('.icon');
      
      if (isValid) {
        element.classList.add('valid');
        icon.textContent = '‚úÖ';
      } else {
        element.classList.remove('valid');
        icon.textContent = '‚ùå';
      }
    }

    function updatePasswordStrength(validReqs) {
      const strengthDiv = document.getElementById('passwordStrength');
      
      if (validReqs === 0) {
        strengthDiv.style.display = 'none';
        return;
      }
      
      strengthDiv.style.display = 'block';
      
      if (validReqs < 2) {
        strengthDiv.className = 'password-strength strength-weak';
        strengthDiv.textContent = 'üî¥ Contrase√±a d√©bil';
      } else if (validReqs < 4) {
        strengthDiv.className = 'password-strength strength-medium';
        strengthDiv.textContent = 'üü° Contrase√±a media';
      } else {
        strengthDiv.className = 'password-strength strength-strong';
        strengthDiv.textContent = 'üü¢ Contrase√±a fuerte';
      }
    }

    function validateForm() {
      const actual = inputs.actual.value.trim();
      const nueva = inputs.nueva.value;
      const confirmar = inputs.confirmar.value;

      // Validar que la nueva contrase√±a cumple todos los requisitos
      const passwordValid = nueva.length >= 8 &&
        /[A-Z]/.test(nueva) &&
        /[a-z]/.test(nueva) &&
        /\d/.test(nueva);

      // Validar confirmaci√≥n
      const confirmValid = confirmar && nueva === confirmar;
      inputs.confirmar.className = confirmar ? (confirmValid ? 'valid' : 'invalid') : '';

      // Habilitar bot√≥n solo si todo est√° v√°lido
      const formValid = actual && passwordValid && confirmValid;
      submitBtn.disabled = !formValid;
    }

    // Manejo del formulario
    document.getElementById('formCambio').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const actual = inputs.actual.value;
      const nueva = inputs.nueva.value;
      const confirmar = inputs.confirmar.value;

      // Validaciones finales
      if (nueva !== confirmar) {
        showMessage('Las contrase√±as no coinciden', 'error');
        return;
      }

      if (nueva === actual) {
        showMessage('La nueva contrase√±a debe ser diferente a la actual', 'error');
        return;
      }

      // Deshabilitar bot√≥n durante el proceso
      submitBtn.disabled = true;
      submitBtn.textContent = 'üîÑ Cambiando...';

      try {
        const res = await window.apiRequest('/api/cambiar-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actual, nueva })
        });

        const data = await res.json();
        
        if (res.ok) {
          // Mostrar modal de √©xito
          showSuccessModal();
        } else {
          if (data.bloqueado) {
            // Si se devuelve que est√° bloqueado, recargar para mostrar el bloqueo
            showMessage('Cambio de contrase√±a bloqueado por tiempo', 'error');
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            showMessage(data.error || 'Error al cambiar contrase√±a', 'error');
          }
        }
      } catch (err) {
        showMessage('Error de conexi√≥n. Intente nuevamente.', 'error');
      } finally {
        submitBtn.textContent = 'üîÑ Cambiar Contrase√±a';
        validateForm(); // Rehabilitar bot√≥n si es necesario
      }
    });

    function showMessage(text, type) {
      mensaje.textContent = text;
      mensaje.className = `mensaje ${type}`;
      mensaje.style.display = 'block';
      
      // Auto ocultar despu√©s de 5 segundos
      setTimeout(() => {
        mensaje.classList.remove('success', 'error');
        mensaje.style.display = 'none';
      }, 5000);
    }

    async function logout() {
      if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
        try {
          await window.apiRequest('/api/logout', { method: 'POST' });
          window.location.href = '/login.html';
        } catch (err) {
          console.error('Error al cerrar sesi√≥n:', err);
        }
      }
    }

    // Ocultar requisitos cuando se hace clic fuera
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.form-group')) {
        if (inputs.nueva.value === '') {
          requirements.classList.remove('show');
        }
      }
    });

    /*BOTON ATRAS PARA CADA USUARIO*/
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await window.apiRequest('/api/usuario-actual');
        if (!response.ok) throw new Error('No autenticado');
        const usuario = await response.json();

        document.getElementById('restaurantName').textContent = usuario.restaurante_nombre || 'Usuario';
        document.getElementById('userName').textContent = usuario.usuario;

        // Mostrar el bot√≥n de volver seg√∫n el tipo de usuario
        const botonVolver = document.createElement('a');
        botonVolver.className = 'btn-volver';
        botonVolver.textContent = '‚¨Ö Volver';

        if (usuario.tipo === 'admin') {
          botonVolver.href = 'inicio_admin.html';
        } else if (usuario.tipo === 'domiciliario') {
          botonVolver.href = 'inicio_domi.html';
        } else {
          botonVolver.href = 'inicio.html';
        }

        document.getElementById('boton-volver-container').appendChild(botonVolver);

        // ‚úÖ Verificar permisos de cambio despu√©s de cargar usuario
        await verificarPermisosCambio();

      } catch (error) {
        console.error('Error al cargar usuario:', error);
      }
    });

    // Cerrar modal si se hace clic fuera de √©l
    document.getElementById('successModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('successModal')) {
        closeSuccessModal();
      }
    });

    // Limpiar interval cuando se cierre la p√°gina
    window.addEventListener('beforeunload', () => {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
    });
  </script>
  <script src="js/info_header.js"></script>
</body>
</html>