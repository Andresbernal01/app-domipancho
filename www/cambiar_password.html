<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cambiar ContraseÃ±a | DomiPancho</title>
  <link rel="icon" href="img/logo.png" />
  <link rel="stylesheet" href="css/cambiar_password.css">
  <script src="js/config.js"></script>

</head>
<body>

  <header class="header">
    <div class="header-container">
      <!-- BotÃ³n Volver -->
      <button class="btn-volver" onclick="window.location.href='inicio_domi.html'">
        â¬… <span>Volver</span>
      </button>

      <!-- Centro: Logo + Nombre -->
      <div class="header-center">
        <img src="img/logo.png" alt="Logo DomiPancho" class="logo" />
        <div class="restaurant-info">
          <h1 id="restaurantName">Cargando...</h1>
        </div>
      </div>

      <div class="restaurant-info">
        <p>ğŸ§‘PERFIL</p>
      </div>

      <!-- Usuario -->
      <div class="header-right" style="display: none;">
        <div class="user-info">
          <div class="user-icon">ğŸ‘¤</div>
          <span class="user-label">Usuario:</span>
          <span id="userName">-</span>
        </div>
      </div>
    </div>
  </header>

  <div class="main-container">
    <!-- ğŸš« Contenedor de bloqueo -->
    <div id="blockedContainer" class="blocked-container" style="display: none;">
      <div class="blocked-icon">ğŸ”’</div>
      <div class="blocked-title">Cambio de ContraseÃ±a Bloqueado</div>
      <div class="blocked-message">
        Por seguridad, solo puedes cambiar tu contraseÃ±a una vez cada <strong>48 horas</strong>.<br>
        Debes esperar el tiempo restante antes de realizar otro cambio.
      </div>
      
      <div class="countdown-container">
        <div class="countdown-title">â±ï¸ Tiempo restante:</div>
        <div class="countdown-display" id="countdownDisplay">00:00:00</div>
        <div class="countdown-labels">
          <span>Horas</span>
          <span>Minutos</span>
          <span>Segundos</span>
        </div>
      </div>

      <div class="blocked-info">
        <strong>ğŸ“… Ãšltimo cambio:</strong> <span id="ultimoCambio">-</span><br>
        <strong>ğŸ• PrÃ³ximo cambio disponible:</strong> <span id="proximoCambio">-</span>
      </div>
    </div>

    <!-- ğŸ“ Formulario normal -->
    <div id="formContainer" class="form-container">
      <div class="form-title">
        ğŸ”‘ Actualizar ContraseÃ±a
      </div>
      
      <form id="formCambio">
        <div class="form-group">
          <label for="actual">ğŸ”’ ContraseÃ±a Actual:</label>
          <div class="password-field">
            <input type="password" name="actual" id="actual" required>
            <button type="button" class="toggle-password" onclick="togglePassword('actual')">ğŸ‘ï¸</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="nueva">ğŸ†• Nueva ContraseÃ±a:</label>
          <div class="password-field">
            <input type="password" name="nueva" id="nueva" required>
            <button type="button" class="toggle-password" onclick="togglePassword('nueva')">ğŸ‘ï¸</button>
          </div>
          
          <div id="passwordRequirements" class="password-requirements">
            <h4>ğŸ“‹ Requisitos de la contraseÃ±a:</h4>
            <div class="requirement" id="req-length">
              <span class="icon">âŒ</span>
              <span>MÃ­nimo 8 caracteres</span>
            </div>
            <div class="requirement" id="req-uppercase">
              <span class="icon">âŒ</span>
              <span>Al menos una letra mayÃºscula</span>
            </div>
            <div class="requirement" id="req-lowercase">
              <span class="icon">âŒ</span>
              <span>Al menos una letra minÃºscula</span>
            </div>
            <div class="requirement" id="req-number">
              <span class="icon">âŒ</span>
              <span>Al menos un nÃºmero</span>
            </div>
            <div id="passwordStrength" class="password-strength"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="confirmar">âœ… Confirmar Nueva ContraseÃ±a:</label>
          <div class="password-field">
            <input type="password" name="confirmar" id="confirmar" required>
            <button type="button" class="toggle-password" onclick="togglePassword('confirmar')">ğŸ‘ï¸</button>
          </div>
        </div>
        
        <button type="submit" class="submit-btn" id="submitBtn" disabled>
          ğŸ”„ Cambiar ContraseÃ±a
        </button>

        <p style="margin-top: 10px; text-align: center; color:#facc15"> Recuerda que solo puedes cambiar la contraseÃ±a una vez cada 48 horas.</p>
        
        <div id="mensaje" class="mensaje"></div>
      </form>
    </div>
  </div>

  <!-- Modal de Ã©xito -->
  <div id="successModal" class="success-modal">
    <div class="success-modal-content">
      <div class="success-icon">ğŸ‰</div>
      <div class="success-title">Â¡ContraseÃ±a Actualizada!</div>
      <div class="success-message">
        Tu contraseÃ±a ha sido cambiada exitosamente.<br>
        Tu cuenta ahora estÃ¡ mÃ¡s segura.<br><br>
        <strong>âš ï¸ Nota:</strong> No podrÃ¡s cambiarla nuevamente durante las prÃ³ximas <strong>48 horas</strong>.
      </div>
      <button class="success-button" onclick="closeSuccessModal()">
        Â¡Perfecto! ğŸ‘
      </button>
    </div>
  </div>

  <script>
    let countdownInterval = null;
    
    const inputs = {
      actual: document.getElementById('actual'),
      nueva: document.getElementById('nueva'),
      confirmar: document.getElementById('confirmar')
    };
    
    const requirements = document.getElementById('passwordRequirements');
    const submitBtn = document.getElementById('submitBtn');
    const mensaje = document.getElementById('mensaje');

    // ğŸ” Verificar si puede cambiar contraseÃ±a al cargar la pÃ¡gina
    async function verificarPermisosCambio() {
      try {
        const response = await window.apiRequest('/api/puede-cambiar-password');
        const data = await response.json();

        if (!data.puede_cambiar) {
          mostrarBloqueoPorTiempo(data);
        } else {
          mostrarFormularioNormal();
        }
      } catch (error) {
        console.error('Error al verificar permisos:', error);
        mostrarFormularioNormal(); // Mostrar formulario por defecto si hay error
      }
    }

    function mostrarBloqueoPorTiempo(data) {
  document.getElementById('blockedContainer').style.display = 'block';
  document.getElementById('formContainer').style.display = 'none'; // ğŸ”’ Oculta el formulario completamente


      // Mostrar informaciÃ³n de fechas
      if (data.ultimo_cambio) {
        document.getElementById('ultimoCambio').textContent = formatearFecha(data.ultimo_cambio);
      }
      if (data.siguiente_cambio) {
        document.getElementById('proximoCambio').textContent = formatearFecha(data.siguiente_cambio);
      }

      // Iniciar countdown
      iniciarCountdown(data.tiempo_restante_ms);
    }

    function mostrarFormularioNormal() {
      document.getElementById('blockedContainer').style.display = 'none';
      document.getElementById('formContainer').classList.remove('blocked');
    }

    function iniciarCountdown(tiempoRestanteMs) {
      let tiempoRestante = tiempoRestanteMs;
      
      const actualizarCountdown = () => {
        if (tiempoRestante <= 0) {
          clearInterval(countdownInterval);
          document.getElementById('countdownDisplay').textContent = 'Â¡Disponible ahora!';
          
          // Recargar la pÃ¡gina para mostrar el formulario
          setTimeout(() => {
            window.location.reload();
          }, 2000);
          return;
        }

        const horas = Math.floor(tiempoRestante / (1000 * 60 * 60));
        const minutos = Math.floor((tiempoRestante % (1000 * 60 * 60)) / (1000 * 60));
        const segundos = Math.floor((tiempoRestante % (1000 * 60)) / 1000);

        const display = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        document.getElementById('countdownDisplay').textContent = display;

        tiempoRestante -= 1000;
      };

      actualizarCountdown();
      countdownInterval = setInterval(actualizarCountdown, 1000);
    }

    function formatearFecha(fechaISO) {
      const fecha = new Date(fechaISO);
      return fecha.toLocaleString('es-CO', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // FunciÃ³n para mostrar/ocultar contraseÃ±a
    function togglePassword(fieldId) {
      const field = document.getElementById(fieldId);
      const button = field.nextElementSibling;
      
      if (field.type === 'password') {
        field.type = 'text';
        button.textContent = 'ğŸ™ˆ';
      } else {
        field.type = 'password';
        button.textContent = 'ğŸ‘ï¸';
      }
    }

    // Mostrar modal de Ã©xito
    function showSuccessModal() {
      document.getElementById('successModal').classList.add('show');
    }

    // Cerrar modal de Ã©xito y recargar para mostrar bloqueo
    function closeSuccessModal() {
      document.getElementById('successModal').classList.remove('show');
      
      // Recargar la pÃ¡gina para mostrar el bloqueo
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }

    // Mostrar requisitos cuando se enfoque en nueva contraseÃ±a
    inputs.nueva.addEventListener('focus', () => {
      requirements.classList.add('show');
    });

    // ValidaciÃ³n en tiempo real de la nueva contraseÃ±a
    inputs.nueva.addEventListener('input', validatePassword);
    inputs.confirmar.addEventListener('input', validateForm);
    inputs.actual.addEventListener('input', validateForm);

    function validatePassword() {
      const password = inputs.nueva.value;
      const reqs = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password)
      };

      // Actualizar indicadores visuales
      updateRequirement('req-length', reqs.length);
      updateRequirement('req-uppercase', reqs.uppercase);
      updateRequirement('req-lowercase', reqs.lowercase);
      updateRequirement('req-number', reqs.number);

      // Calcular fortaleza
      const validReqs = Object.values(reqs).filter(Boolean).length;
      updatePasswordStrength(validReqs);

      // Validar input
      const isValid = Object.values(reqs).every(Boolean);
      inputs.nueva.className = password ? (isValid ? 'valid' : 'invalid') : '';

      validateForm();
    }

    function updateRequirement(id, isValid) {
      const element = document.getElementById(id);
      const icon = element.querySelector('.icon');
      
      if (isValid) {
        element.classList.add('valid');
        icon.textContent = 'âœ…';
      } else {
        element.classList.remove('valid');
        icon.textContent = 'âŒ';
      }
    }

    function updatePasswordStrength(validReqs) {
      const strengthDiv = document.getElementById('passwordStrength');
      
      if (validReqs === 0) {
        strengthDiv.style.display = 'none';
        return;
      }
      
      strengthDiv.style.display = 'block';
      
      if (validReqs < 2) {
        strengthDiv.className = 'password-strength strength-weak';
        strengthDiv.textContent = 'ğŸ”´ ContraseÃ±a dÃ©bil';
      } else if (validReqs < 4) {
        strengthDiv.className = 'password-strength strength-medium';
        strengthDiv.textContent = 'ğŸŸ¡ ContraseÃ±a media';
      } else {
        strengthDiv.className = 'password-strength strength-strong';
        strengthDiv.textContent = 'ğŸŸ¢ ContraseÃ±a fuerte';
      }
    }

    function validateForm() {
      const actual = inputs.actual.value.trim();
      const nueva = inputs.nueva.value;
      const confirmar = inputs.confirmar.value;

      // Validar que la nueva contraseÃ±a cumple todos los requisitos
      const passwordValid = nueva.length >= 8 &&
        /[A-Z]/.test(nueva) &&
        /[a-z]/.test(nueva) &&
        /\d/.test(nueva);

      // Validar confirmaciÃ³n
      const confirmValid = confirmar && nueva === confirmar;
      inputs.confirmar.className = confirmar ? (confirmValid ? 'valid' : 'invalid') : '';

      // Habilitar botÃ³n solo si todo estÃ¡ vÃ¡lido
      const formValid = actual && passwordValid && confirmValid;
      submitBtn.disabled = !formValid;
    }

    // Manejo del formulario
    document.getElementById('formCambio').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const actual = inputs.actual.value;
      const nueva = inputs.nueva.value;
      const confirmar = inputs.confirmar.value;

      // Validaciones finales
      if (nueva !== confirmar) {
        showMessage('Las contraseÃ±as no coinciden', 'error');
        return;
      }

      if (nueva === actual) {
        showMessage('La nueva contraseÃ±a debe ser diferente a la actual', 'error');
        return;
      }

      // Deshabilitar botÃ³n durante el proceso
      submitBtn.disabled = true;
      submitBtn.textContent = 'ğŸ”„ Cambiando...';

      try {
        const res = await window.apiRequest('/api/cambiar-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actual, nueva })
        });

        const data = await res.json();
        
        if (res.ok) {
          // Mostrar modal de Ã©xito
          showSuccessModal();
        } else {
          if (data.bloqueado) {
            // Si se devuelve que estÃ¡ bloqueado, recargar para mostrar el bloqueo
            showMessage('Cambio de contraseÃ±a bloqueado por tiempo', 'error');
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            showMessage(data.error || 'Error al cambiar contraseÃ±a', 'error');
          }
        }
      } catch (err) {
        showMessage('Error de conexiÃ³n. Intente nuevamente.', 'error');
      } finally {
        submitBtn.textContent = 'ğŸ”„ Cambiar ContraseÃ±a';
        validateForm(); // Rehabilitar botÃ³n si es necesario
      }
    });

    function showMessage(text, type) {
      mensaje.textContent = text;
      mensaje.className = `mensaje ${type}`;
      mensaje.style.display = 'block';
      
      // Auto ocultar despuÃ©s de 5 segundos
      setTimeout(() => {
        mensaje.classList.remove('success', 'error');
        mensaje.style.display = 'none';
      }, 5000);
    }

    async function logout() {
      if (confirm('Â¿EstÃ¡ seguro que desea cerrar sesiÃ³n?')) {
        try {
          await window.apiRequest('/api/logout', { method: 'POST' });
          window.location.href = '/login.html';
        } catch (err) {
          console.error('Error al cerrar sesiÃ³n:', err);
        }
      }
    }

    // Ocultar requisitos cuando se hace clic fuera
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.form-group')) {
        if (inputs.nueva.value === '') {
          requirements.classList.remove('show');
        }
      }
    });

    /*BOTON ATRAS PARA CADA USUARIO*/
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await window.apiRequest('/api/usuario-actual');
        if (!response.ok) throw new Error('No autenticado');
        const usuario = await response.json();

        document.getElementById('restaurantName').textContent = usuario.restaurante_nombre || 'Usuario';
        document.getElementById('userName').textContent = usuario.usuario;

        // Mostrar el botÃ³n de volver segÃºn el tipo de usuario
        const botonVolver = document.createElement('a');
        botonVolver.className = 'btn-volver';
        botonVolver.textContent = 'â¬… Volver';

        if (usuario.tipo === 'admin') {
          botonVolver.href = 'inicio_admin.html';
        } else if (usuario.tipo === 'domiciliario') {
          botonVolver.href = 'inicio_domi.html';
        } else {
          botonVolver.href = 'inicio.html';
        }

        document.getElementById('boton-volver-container').appendChild(botonVolver);

        // âœ… Verificar permisos de cambio despuÃ©s de cargar usuario
        await verificarPermisosCambio();

      } catch (error) {
        console.error('Error al cargar usuario:', error);
      }
    });

    // Cerrar modal si se hace clic fuera de Ã©l
    document.getElementById('successModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('successModal')) {
        closeSuccessModal();
      }
    });

    // Limpiar interval cuando se cierre la pÃ¡gina
    window.addEventListener('beforeunload', () => {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
    });
  </script>
  <script src="js/info_header.js"></script>
</body>
</html>